rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    function estaLogado() {
      return request.auth != null;
    }

    function eDono(campoId) {
      return estaLogado() && request.auth.uid == resource.data[campoId];
    }

    function vaiSerDono(campoId) {
      return estaLogado() && request.auth.uid == request.resource.data[campoId];
    }

    // --- REGRAS ---

    match /usuarios/{userId} {
      allow read: if true; 
      allow write: if estaLogado() && request.auth.uid == userId;
    }
    
    match /status_usuario/{userId} {
      allow read, write: if estaLogado() && request.auth.uid == userId;
    }

    // OBRAS: Visitantes podem ler e incrementar views
    match /obras/{obraId} {
      allow read: if resource.data.status == 'public' || eDono('autorId');
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      
      allow update: if eDono('autorId') || 
                    // Removemos 'estaLogado()' daqui para permitir views de visitantes
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'rating', 'votes']));
    }

    // CAPÍTULOS: Visitantes podem ler e incrementar views
    match /capitulos/{capId} {
      allow read: if true;
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      
      allow update: if eDono('autorId') || 
                    // Removemos 'estaLogado()' daqui para permitir views de visitantes
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']));
    }

    // VISUALIZAÇÕES ÚNICAS (Correção do Erro)
    match /visualizacoes_capitulos/{docId} {
       // Permite ler se for seu OU se o documento não existir (para verificar criação)
       allow read: if estaLogado() && (resource == null || resource.data.userId == request.auth.uid);
       allow write: if estaLogado() && request.resource.data.userId == request.auth.uid;
    }

    match /comentarios/{comId} {
      allow read: if true;
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      allow update: if estaLogado() 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    match /avaliacoes/{docId} {
      allow read: if true;
      allow write: if estaLogado() && request.resource.data.userId == request.auth.uid;
    }

    match /biblioteca/{docId} {
      // Permite leitura se não existir (null) ou se for dono
      allow read: if estaLogado() && (resource == null || resource.data.userId == request.auth.uid);
      allow write: if estaLogado() && request.resource.data.userId == request.auth.uid;
      allow delete: if estaLogado() && resource.data.userId == request.auth.uid;
    }
    
    // HISTÓRICO (Correção do Erro)
    match /historico/{docId} {
      // Permite leitura se não existir (null) ou se for dono
      allow read: if estaLogado() && (resource == null || resource.data.userId == request.auth.uid);
      allow write: if estaLogado() && request.resource.data.userId == request.auth.uid;
      allow delete: if estaLogado() && resource.data.userId == request.auth.uid;
    }

    match /seguidores/{docId} {
      allow read: if true;
      allow create, delete: if estaLogado() && (request.resource.data.seguidorId == request.auth.uid || resource.data.seguidorId == request.auth.uid);
    }

    match /notificacoes/{notifId} {
      allow read: if estaLogado() && resource.data.paraId == request.auth.uid;
      allow create: if estaLogado();
      allow update: if estaLogado() && resource.data.paraId == request.auth.uid;
      allow delete: if estaLogado() && resource.data.paraId == request.auth.uid;
    }
  }
}