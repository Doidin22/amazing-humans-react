rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    function estaLogado() {
      return request.auth != null;
    }

    function eDono(campoId) {
      return estaLogado() && request.auth.uid == resource.data[campoId];
    }

    function vaiSerDono(campoId) {
      return estaLogado() && request.auth.uid == request.resource.data[campoId];
    }

    // --- REGRAS ---

    // 1. USUÁRIOS
    match /usuarios/{userId} {
      allow read: if true; 
      allow write: if estaLogado() && request.auth.uid == userId;
    }
    
    // 2. STATUS USUÁRIO
    match /status_usuario/{userId} {
      allow read, write: if estaLogado() && request.auth.uid == userId;
    }

    // 3. OBRAS
    match /obras/{obraId} {
      allow read: if resource.data.status == 'public' || eDono('autorId');
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      
      // Permite atualizar se for dono OU se estiver atualizando apenas métricas
      allow update: if eDono('autorId') || 
                    (estaLogado() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'rating', 'votes']));
    }

    // 4. CAPÍTULOS
    match /capitulos/{capId} {
      allow read: if true;
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      allow update: if eDono('autorId') || 
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']));
    }

    // 5. COMENTÁRIOS
    match /comentarios/{comId} {
      allow read: if true;
      allow create: if vaiSerDono('autorId');
      allow delete: if eDono('autorId');
      allow update: if estaLogado() 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    // 6. AVALIAÇÕES
    match /avaliacoes/{docId} {
      allow read: if true;
      allow write: if estaLogado() && request.resource.data.userId == request.auth.uid;
    }

    // 7. BIBLIOTECA
    match /biblioteca/{docId} {
      allow read: if estaLogado() && resource.data.userId == request.auth.uid;
      allow create: if estaLogado() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if estaLogado() && resource.data.userId == request.auth.uid;
    }
    
    // 8. HISTÓRICO (CORRIGIDO E SIMPLIFICADO)
    match /historico/{docId} {
      // Leitura: Permitida se o documento salvo pertencer ao usuário logado
      allow read: if estaLogado() && resource.data.userId == request.auth.uid;
      
      // Criação/Atualização: Permitida se o 'userId' enviado for igual ao ID do usuário logado
      allow create, update: if estaLogado() && request.resource.data.userId == request.auth.uid;
      
      // Deleção: Permitida se o documento pertencer ao usuário
      allow delete: if estaLogado() && resource.data.userId == request.auth.uid;
    }

    // 9. SEGUIDORES
    match /seguidores/{docId} {
      allow read: if true;
      allow create, delete: if estaLogado() && (request.resource.data.seguidorId == request.auth.uid || resource.data.seguidorId == request.auth.uid);
    }

    // 10. NOTIFICAÇÕES
    match /notificacoes/{notifId} {
      allow read: if estaLogado() && resource.data.paraId == request.auth.uid;
      allow create: if estaLogado();
      allow update: if estaLogado() && resource.data.paraId == request.auth.uid;
    }
  }
}